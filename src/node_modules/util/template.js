"use strict";

var format = require("util").format;

module.exports = template;

var pattern = /<%([^%]*)%>/g;
var keyword = /if|else|for|break|continue|switch|case|{|}/;

function template(tpl, params){
	var codeList = ['var r=[];'];
	genCodeList(tpl, codeList);
	codeList.push('return r.join("");');
	var funcRef = new Function(codeList.join("\n"));
	return funcRef.apply(params);
}

function genCodeList(tpl, codeList){
	var match, cursor = 0;
	while(match = pattern.exec(tpl)){
		addLine(codeList, tpl.slice(cursor, match.index));
		addLine(codeList, match[1], true);
		cursor = match.index + match[0].length;
	}
	addLine(codeList, tpl.slice(cursor));
}

function addLine(codeList, line, isJs){
	if(!isJs){
		line = line.replace(/"/g, '\\"');
		line = format('r.push("%s");', line);
	}else if(line.search(keyword) < 0){
		line = format('r.push(%s);', line);
	}
	codeList.push(line);
}